<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>#freeholyC Chat — EASY Uploads (Fixed)</title>
<style>
  :root{
    --panel-bg: rgba(0,0,0,0.6);
    --accent: #7cffb2;
    --muted: #bdbdbd;
    --error: #ff7c7c;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#060609,#0b1220);color:white;overflow:hidden;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  /* Ads */
  .ad { position: absolute; top: 50%; transform: translateY(-50%); width: 140px; height: auto; border-radius:8px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
  .ad.left { left: 8px; }
  .ad.right { right: 8px; }
  .ad img { display:block; width:100%; height:auto; border-radius:8px; }
  /* Chat panel */
  .chat-wrap { position:absolute; inset: 10px 170px; display:flex; flex-direction:column; gap:8px; }
  .header { display:flex; align-items:center; gap:12px; padding:10px; background:var(--panel-bg); border-radius:8px; box-shadow: 0 4px 16px rgba(0,0,0,.6); }
  .header h1{margin:0;font-size:1.05rem; color:var(--accent); letter-spacing:0.08em;}
  .header .sub{color:var(--muted);font-size:0.85rem}
  .messages { flex:1; overflow:auto; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-radius:8px; }
  .controls { display:flex; gap:8px; align-items:center; padding:8px; background:var(--panel-bg); border-radius:8px; }
  input[type=text], input[type=file] { background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); padding:8px; color:white; border-radius:6px; }
  input[name=name]{width:160px}
  input[name=message]{flex:1; min-width:120px}
  button { background:linear-gradient(90deg,#1fd2a6,#3aa5ff); border:0; padding:8px 12px; border-radius:6px; cursor:pointer; color:#022; font-weight:700; transition: filter 0.2s; }
  button:disabled { background: #555; cursor: not-allowed; filter: grayscale(80%); }
  .msg { margin-bottom:12px; }
  .meta{ font-size:0.78rem; color:var(--muted); margin-bottom:4px; }
  .text{ white-space:pre-wrap; word-break:break-word; font-size:0.98rem; color:#f7f7f7 }
  img.msg-media, video.msg-media { max-width:420px; max-height:280px; display:block; margin-top:8px; border-radius:6px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
  /* many flying #freeholyC */
  .freeholy-c { position:absolute; font-weight:800; pointer-events:none; user-select:none; text-shadow:0 2px 6px rgba(0,0,0,0.6); }
  .upload-status { font-size: 0.8rem; color: var(--accent); margin-left: 10px; }
  /* small screens adjustments */
  @media (max-width:900px){
    .ad{display:none}
    .chat-wrap{inset:8px 8px}
  }
</style>
</head>
<body>

<!-- Ad slots -->
<a class="ad left" href="#" target="_blank" id="leftAd"><img src="https://i.imgur.com/aC2gfh8.jpeg" alt="left ad"></a>
<a class="ad right" href="#" target="_blank" id="rightAd"><img src="https://i.imgur.com/aC2gfh8.jpeg" alt="right ad"></a>

<!-- Chat area -->
<div class="chat-wrap">
  <div class="header">
    <h1>#freeholyC chat</h1>
    <div class="sub">Realtime sync • Media up to 100MB • No setup required</div>
  </div>

  <div class="messages" id="messages" aria-live="polite"></div>

  <div class="controls">
    <input type="text" name="name" id="nameInput" placeholder="username">
    <input type="text" name="message" id="textInput" placeholder="Type a message and press Enter">
    <input type="file" id="fileInput" accept="image/*,video/*" title="Upload images or videos (deleted after 14 days)">
    <button id="sendBtn">Send</button>
    <div id="uploadStatus" class="upload-status"></div>
  </div>
</div>

<!-- freeholyC container (we'll create many) -->
<div id="freeholyContainer" aria-hidden="true"></div>

<script type="module">
/*
  Single-file realtime chat using Gun.js.
  File uploads are handled by transfer.sh for free, zero-config hosting.
  NOTE: Uploaded files are automatically deleted after 14 days.
*/

/* ===== CONFIG ===== */
// Public Gun peers (relay).
const GUN_PEERS = [
  'https://gun.ecc.ac',
  'https://gun-us.herokuapp.com/gun',
  'https://gun-eu.herokuapp.com/gun'
];

// Room name (multiple rooms possible by changing)
const ROOM = 'freeholyc-room-1';

// Maximum allowed file size (100 MB)
const MAX_SIZE_BYTES = 100 * 1024 * 1024;

/* ===== END CONFIG ===== */

import Gun from 'https://cdn.jsdelivr.net/npm/gun/gun.mjs';

// Get all the HTML elements we need
const messagesEl = document.getElementById('messages');
const nameInput = document.getElementById('nameInput');
const textInput = document.getElementById('textInput');
const fileInput = document.getElementById('fileInput');
const sendBtn = document.getElementById('sendBtn');
const uploadStatusEl = document.getElementById('uploadStatus');
const leftAd = document.getElementById('leftAd');
const rightAd = document.getElementById('rightAd');

// Exit if essential elements are missing
if (!messagesEl || !nameInput || !textInput || !fileInput || !sendBtn || !uploadStatusEl) {
  throw new Error("A critical chat element is missing from the HTML.");
}

const gun = Gun({ peers: GUN_PEERS });
const room = gun.get('rooms').get(ROOM);
const messagesNode = room.get('messages');

// Pre-fill username from localStorage
const savedName = localStorage.getItem('freeholyc_name');
if (savedName) nameInput.value = savedName;

// Save name on change
nameInput.addEventListener('change', () => localStorage.setItem('freeholyc_name', nameInput.value));

const seen = new Set();
const initialBuffer = [];
let initialLoaded = false;

function textNodeFromString(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d;
}

function renderMessage(msg) {
  if (!msg || !msg.id || seen.has(msg.id)) return;
  seen.add(msg.id);

  const el = document.createElement('div');
  el.className = 'msg';

  const meta = document.createElement('div');
  meta.className = 'meta';
  const time = new Date(msg.ts || Date.now()).toLocaleString();
  meta.textContent = `${msg.name || 'anon'} • ${time}`;
  el.appendChild(meta);

  const body = document.createElement('div');
  body.className = 'text';

  if (msg.media && msg.contentType) {
    if (msg.contentType.startsWith('image')) {
      const img = document.createElement('img');
      img.className = 'msg-media';
      img.src = msg.text;
      img.alt = '#freeholyC image';
      img.loading = 'lazy';
      body.appendChild(img);
    } else if (msg.contentType.startsWith('video')) {
      const vid = document.createElement('video');
      vid.className = 'msg-media';
      vid.controls = true;
      vid.src = msg.text;
      body.appendChild(vid);
    } else {
      const a = document.createElement('a');
      a.href = msg.text;
      a.textContent = 'Open media';
      a.target = '_blank';
      body.appendChild(a);
    }
  } else {
    body.appendChild(textNodeFromString(msg.text || ''));
  }

  el.appendChild(body);
  messagesEl.appendChild(el);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

messagesNode.map().once((msg) => {
  if (msg && msg.id) {
    initialBuffer.push(msg);
  }
});

setTimeout(() => {
  initialBuffer.sort((a, b) => new Date(a.ts).getTime() - new Date(b.ts).getTime());
  initialBuffer.forEach(renderMessage);
  initialLoaded = true;
}, 600);

messagesNode.map().on((msg) => {
  if (!msg || !msg.id) return;
  if (!initialLoaded) {
    if (!initialBuffer.some(item => item.id === msg.id)) {
        initialBuffer.push(msg);
    }
    return;
  }
  renderMessage(msg);
});

function sendText() {
  const text = textInput.value.trim();
  if (!text) return;
  const name = nameInput.value.trim() || 'anon';
  const msg = {
    id: Gun.text.random(),
    name, text,
    ts: new Date().toISOString(),
    media: false
  };
  messagesNode.set(msg);
  textInput.value = '';
}

function setUploadStatus(text, isError = false) {
    uploadStatusEl.textContent = text;
    uploadStatusEl.style.color = isError ? 'var(--error)' : 'var(--accent)';
}

function setControlsDisabled(disabled) {
    sendBtn.disabled = disabled;
    textInput.disabled = disabled;
    fileInput.disabled = disabled;
}

async function uploadFile(file) {
    const uploadUrl = `https://transfer.sh/${file.name}`;

    const response = await fetch(uploadUrl, {
        method: 'PUT',
        body: file,
    });

    if (!response.ok) {
        throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
    }

    // The response body is the direct URL to the file
    return await response.text();
}

async function sendFile(file) {
  if (!file) return;
  if (file.size > MAX_SIZE_BYTES) {
    alert('File too large — max 100 MB');
    return;
  }

  setControlsDisabled(true);
  setUploadStatus('Uploading...');

  try {
    const fileUrl = await uploadFile(file);
    const name = nameInput.value.trim() || 'anon';
    const msg = {
      id: Gun.text.random(),
      name,
      text: fileUrl,
      ts: new Date().toISOString(),
      media: true,
      contentType: file.type
    };
    messagesNode.set(msg);
    setUploadStatus('Upload complete!', false);
  } catch (e) {
    console.error('File send error', e);
    setUploadStatus(`Upload failed!`, true);
    alert(`File upload failed. See console for details.`);
  } finally {
    setControlsDisabled(false);
    setTimeout(() => setUploadStatus(''), 3000);
  }
}

sendBtn.addEventListener('click', sendText);
textInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendText();
});
fileInput.addEventListener('change', () => {
  const file = fileInput.files?.[0];
  if (!file) return;
  sendFile(file);
  fileInput.value = ''; // Reset for re-uploading the same file
});

(function initAds() {
  if (!leftAd || !rightAd) return;
  const leftImg = leftAd.querySelector('img');
  const rightImg = rightAd.querySelector('img');

  if (leftImg) leftAd.href = leftImg.src;
  if (rightImg) rightAd.href = rightImg.src;
})();

(function spawnFreeHoly() {
  const container = document.getElementById('freeholyContainer');
  if (!container) return;
  const COUNT = Math.min(Math.max(16, Math.floor(window.innerWidth * window.innerHeight / 80000)), 80);
  const items = [];

  for (let i = 0; i < COUNT; i++) {
    const span = document.createElement('div');
    span.className = 'freeholy-c';
    span.textContent = '#freeholyC';
    const size = 12 + Math.random() * 40;
    span.style.fontSize = size + 'px';
    span.style.opacity = (0.35 + Math.random() * 0.9).toString();
    container.appendChild(span);
    const x = Math.random() * (window.innerWidth - 60);
    const y = Math.random() * (window.innerHeight - 60);
    const vx = (Math.random() * 3 + 0.8) * (Math.random() > 0.5 ? 1 : -1);
    const vy = (Math.random() * 3 + 0.8) * (Math.random() > 0.5 ? 1 : -1);
    const rot = Math.random() * 360;
    const vrot = (Math.random() * 2 + 0.2) * (Math.random() > 0.5 ? 1 : -1);
    items.push({ el: span, x, y, vx, vy, rot, vrot, size });
  }

  function step() {
    for (const it of items) {
      it.x += it.vx;
      it.y += it.vy;
      it.rot += it.vrot;
      const w = it.el.offsetWidth;
      const h = it.el.offsetHeight;
      if (it.x <= 0 || it.x + w >= window.innerWidth) {
        it.vx *= -1;
        it.el.style.color = randomColor();
      }
      if (it.y <= 0 || it.y + h >= window.innerHeight) {
        it.vy *= -1;
        it.el.style.color = randomColor();
      }
      it.el.style.left = Math.max(0, Math.min(window.innerWidth - w, it.x)) + 'px';
      it.el.style.top = Math.max(0, Math.min(window.innerHeight - h, it.y)) + 'px';
      it.el.style.transform = `rotate(${it.rot}deg)`;
    }
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

  function randomColor() {
    const r = Math.floor(120 + Math.random() * 135);
    const g = Math.floor(80 + Math.random() * 175);
    const b = Math.floor(80 + Math.random() * 175);
    return `rgb(${r},${g},${b})`;
  }

  window.addEventListener('resize', () => {
    for (const it of items) {
      it.x = Math.random() * (window.innerWidth - 80);
      it.y = Math.random() * (window.innerHeight - 80);
    }
  });
})();

console.log('#freeholyC chat ready — Gun peers:', GUN_PEERS);

</script>
</body>
</html>
